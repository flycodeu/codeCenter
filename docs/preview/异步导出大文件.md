---
title: å¼‚æ­¥å¯¼å‡ºå¤§æ–‡ä»¶
createTime: 2025/10/21 15:35:55
permalink: /article/5a3cwwps/
cover: https://flycodeu-1314556962.cos.ap-nanjing.myqcloud.com/codeCenterImg/b34365d4f30c36d47e3a854a28b13d0f.jpg
tags:
  - SpringBoot
---
# Excelå¤§æ•°æ®å¼‚æ­¥å¯¼å‡ºé€šç”¨è§£å†³æ–¹æ¡ˆ

> ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å¼‚æ­¥å¯¼å‡ºæ¡†æ¶ï¼Œæ”¯æŒå¤§æ•°æ®é‡ã€å›¾ç‰‡ã€è¿›åº¦è¿½è¸ªï¼Œå¯å¿«é€Ÿé›†æˆåˆ°ä»»ä½•Spring Booté¡¹ç›®

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°](#ä¸€æ–¹æ¡ˆæ¦‚è¿°)
- [äºŒã€å¿«é€Ÿå¼€å§‹](#äºŒå¿«é€Ÿå¼€å§‹)
- [ä¸‰ã€æ ¸å¿ƒä»£ç ](#ä¸‰æ ¸å¿ƒä»£ç )
- [å››ã€ä½¿ç”¨ç¤ºä¾‹](#å››ä½¿ç”¨ç¤ºä¾‹)
- [äº”ã€é«˜çº§ç‰¹æ€§](#äº”é«˜çº§ç‰¹æ€§)
- [å…­ã€æ€§èƒ½ä¼˜åŒ–](#å…­æ€§èƒ½ä¼˜åŒ–)
- [ä¸ƒã€å¸¸è§é—®é¢˜](#ä¸ƒå¸¸è§é—®é¢˜)

---

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 è§£å†³çš„é—®é¢˜

- âœ… å¯¼å‡ºå¤§é‡æ•°æ®æ—¶æµè§ˆå™¨è¶…æ—¶
- âœ… åŒæ­¥å¯¼å‡ºå¯¼è‡´é¡µé¢é•¿æ—¶é—´æ— å“åº”
- âœ… åŒ…å«å›¾ç‰‡ç­‰äºŒè¿›åˆ¶èµ„æºå¯¼è‡´å†…å­˜æº¢å‡º
- âœ… æ— æ³•è¿½è¸ªå¯¼å‡ºè¿›åº¦
- âœ… å¯¼å‡ºå¤±è´¥æ— æ³•é‡è¯•

### 1.2 æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨    â”‚                    â”‚   åç«¯æœåŠ¡    â”‚
â”‚              â”‚  â‘ åˆ›å»ºå¯¼å‡ºä»»åŠ¡      â”‚              â”‚
â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚              â”‚
â”‚              â”‚  â‘¡è¿”å›ä»»åŠ¡ID        â”‚              â”‚
â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚              â”‚                    â”‚              â”‚
â”‚  è¿›åº¦å±•ç¤º     â”‚  â‘¢è½®è¯¢ä»»åŠ¡çŠ¶æ€      â”‚  å¼‚æ­¥å¤„ç†     â”‚
â”‚  (2ç§’/æ¬¡)    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  (çº¿ç¨‹æ± )    â”‚
â”‚              â”‚                    â”‚              â”‚
â”‚              â”‚  â‘£ä»»åŠ¡å®Œæˆé€šçŸ¥      â”‚              â”‚
â”‚              â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚              â”‚  â‘¤ä¸‹è½½æ–‡ä»¶          â”‚              â”‚
â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| ğŸš€ **å¼€ç®±å³ç”¨** | åªéœ€å®ç°æ•°æ®æŸ¥è¯¢æ¥å£å³å¯ä½¿ç”¨ |
| ğŸ“Š **è¿›åº¦è¿½è¸ª** | å®æ—¶æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦å’Œå¤„ç†æ•°é‡ |
| ğŸ¯ **æ³›å‹è®¾è®¡** | æ”¯æŒä»»æ„æ•°æ®ç±»å‹çš„å¯¼å‡º |
| ğŸ–¼ï¸ **å›¾ç‰‡æ”¯æŒ** | å†…ç½®å›¾ç‰‡å¼‚æ­¥ä¸‹è½½å’Œè¶…æ—¶æ§åˆ¶ |
| ğŸ’¾ **åˆ†æ‰¹å¤„ç†** | é¿å…å†…å­˜æº¢å‡ºï¼Œæ”¯æŒç™¾ä¸‡çº§æ•°æ® |
| ğŸ”„ **æ–­ç‚¹ç»­ä¼ ** | æ”¯æŒä»»åŠ¡é‡è¯•å’Œå¤±è´¥æ¢å¤ |
| ğŸ—‚ï¸ **å†å²è®°å½•** | ä¿å­˜å¯¼å‡ºå†å²ï¼Œéšæ—¶é‡æ–°ä¸‹è½½ |
| ğŸ” **æƒé™æ§åˆ¶** | ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„å¯¼å‡ºæ–‡ä»¶ |

---

## äºŒã€å¿«é€Ÿå¼€å§‹

### 2.1 Mavenä¾èµ–

```xml
<dependencies>
    <!-- Spring Boot Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- MyBatis Plus -->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
        <version>3.5.3.1</version>
    </dependency>
    
    <!-- POI for Excel -->
    <dependency>
        <groupId>org.apache.poi</groupId>
        <artifactId>poi-ooxml</artifactId>
        <version>5.2.3</version>
    </dependency>
    
    <!-- Hutoolå·¥å…·ç±» -->
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.8.18</version>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

### 2.2 é…ç½®æ–‡ä»¶

```yaml
# application.yml
spring:
  # å¼‚æ­¥ä»»åŠ¡é…ç½®
  task:
    execution:
      pool:
        core-size: 2
        max-size: 5
        queue-capacity: 100
        keep-alive: 60s

# å¯¼å‡ºé…ç½®
export:
  # æ–‡ä»¶å­˜å‚¨è·¯å¾„
  file-path: /data/export
  # æ–‡ä»¶ä¿ç•™å¤©æ•°
  keep-days: 7
  # å•ç”¨æˆ·æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
  max-concurrent-per-user: 3
  # å…¨å±€æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
  max-concurrent-global: 50
```

### 2.3 æ•°æ®åº“è„šæœ¬

```sql
-- å¯¼å‡ºä»»åŠ¡è¡¨
CREATE TABLE `export_task` (
  `id` varchar(32) NOT NULL COMMENT 'ä»»åŠ¡ID',
  `task_name` varchar(200) DEFAULT NULL COMMENT 'ä»»åŠ¡åç§°',
  `task_type` varchar(50) DEFAULT NULL COMMENT 'ä»»åŠ¡ç±»å‹',
  `status` tinyint(4) DEFAULT 0 COMMENT 'çŠ¶æ€ï¼š0-å¾…å¤„ç† 1-å¤„ç†ä¸­ 2-å·²å®Œæˆ 3-å¤±è´¥ 4-å·²è¿‡æœŸ',
  `progress` int(11) DEFAULT 0 COMMENT 'è¿›åº¦ç™¾åˆ†æ¯”(0-100)',
  `query_params` text COMMENT 'æŸ¥è¯¢å‚æ•°(JSON)',
  `total_count` int(11) DEFAULT NULL COMMENT 'æ€»è®°å½•æ•°',
  `processed_count` int(11) DEFAULT 0 COMMENT 'å·²å¤„ç†æ•°é‡',
  `file_path` varchar(500) DEFAULT NULL COMMENT 'æ–‡ä»¶å­˜å‚¨è·¯å¾„',
  `file_name` varchar(200) DEFAULT NULL COMMENT 'æ–‡ä»¶å',
  `file_size` bigint(20) DEFAULT NULL COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
  `error_msg` text COMMENT 'é”™è¯¯ä¿¡æ¯',
  `create_user` varchar(32) DEFAULT NULL COMMENT 'åˆ›å»ºäººID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `finish_time` datetime DEFAULT NULL COMMENT 'å®Œæˆæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_create_user` (`create_user`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¯¼å‡ºä»»åŠ¡è¡¨';
```

---

## ä¸‰ã€æ ¸å¿ƒä»£ç 

### 3.1 é€šç”¨æ•°æ®æä¾›è€…æ¥å£

```java
package com.example.export.core;

import java.util.List;

/**
 * å¯¼å‡ºæ•°æ®æä¾›è€…æ¥å£
 * @param <T> æ•°æ®å®ä½“ç±»å‹
 */
public interface ExportDataProvider<T> {
    
    /**
     * æŸ¥è¯¢æ€»è®°å½•æ•°
     * @param params æŸ¥è¯¢å‚æ•°
     * @return æ€»æ•°
     */
    int queryTotalCount(String params);
    
    /**
     * åˆ†é¡µæŸ¥è¯¢æ•°æ®
     * @param params æŸ¥è¯¢å‚æ•°
     * @param offset åç§»é‡
     * @param limit æ¯é¡µæ•°é‡
     * @return æ•°æ®åˆ—è¡¨
     */
    List<T> queryData(String params, int offset, int limit);
}
```

### 3.2 Excelè¡Œæ•°æ®è½¬æ¢å™¨æ¥å£

```java
package com.example.export.core;

import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Workbook;

/**
 * Excelè¡Œæ•°æ®è½¬æ¢å™¨
 * @param <T> æ•°æ®å®ä½“ç±»å‹
 */
public interface ExcelRowConverter<T> {
    
    /**
     * è·å–è¡¨å¤´
     * @return è¡¨å¤´æ•°ç»„
     */
    String[] getHeaders();
    
    /**
     * è®¾ç½®åˆ—å®½
     * @return åˆ—å®½æ•°ç»„ï¼ˆå•ä½ï¼š256åˆ†ä¹‹ä¸€å­—ç¬¦ï¼‰
     */
    default int[] getColumnWidths() {
        return new int[0]; // é»˜è®¤ä½¿ç”¨è‡ªåŠ¨å®½åº¦
    }
    
    /**
     * å°†æ•°æ®è½¬æ¢ä¸ºExcelè¡Œ
     * @param workbook Excelå·¥ä½œç°¿
     * @param row Excelè¡Œå¯¹è±¡
     * @param data æ•°æ®å¯¹è±¡
     * @param rowIndex è¡Œç´¢å¼•
     */
    void convertToRow(Workbook workbook, Row row, T data, int rowIndex);
}
```

### 3.3 é€šç”¨å¼‚æ­¥å¯¼å‡ºå¤„ç†å™¨

```java
package com.example.export.core;

import cn.hutool.core.date.DateUtil;
import cn.hutool.core.util.IdUtil;
import lombok.extern.slf4j.Slf4j;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.streaming.SXSSFWorkbook;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.io.File;
import java.io.FileOutputStream;
import java.util.Date;
import java.util.List;

/**
 * é€šç”¨å¼‚æ­¥å¯¼å‡ºå¤„ç†å™¨
 */
@Slf4j
@Component
public class GenericAsyncExportHandler {
    
    @Resource
    private ExportTaskService exportTaskService;
    
    @Value("${export.file-path:/data/export}")
    private String exportFilePath;
    
    /**
     * æ‰§è¡Œå¯¼å‡ºä»»åŠ¡
     * @param taskId ä»»åŠ¡ID
     * @param taskType ä»»åŠ¡ç±»å‹
     * @param dataProvider æ•°æ®æä¾›è€…
     * @param rowConverter è¡Œè½¬æ¢å™¨
     * @param queryParams æŸ¥è¯¢å‚æ•°(JSONæ ¼å¼)
     * @param <T> æ•°æ®ç±»å‹
     */
    @Async("exportTaskExecutor")
    public <T> void executeExport(
            String taskId,
            String taskType,
            ExportDataProvider<T> dataProvider,
            ExcelRowConverter<T> rowConverter,
            String queryParams) {
        
        log.info("å¼€å§‹æ‰§è¡Œå¯¼å‡ºä»»åŠ¡: taskId={}, taskType={}", taskId, taskType);
        
        SXSSFWorkbook workbook = null;
        FileOutputStream fos = null;
        
        try {
            // 1. æŸ¥è¯¢æ€»æ•°
            int totalCount = dataProvider.queryTotalCount(queryParams);
            log.info("æŸ¥è¯¢åˆ°æ•°æ®æ€»æ•°: {}", totalCount);
            
            if (totalCount == 0) {
                exportTaskService.updateTaskFailed(taskId, "æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®");
                return;
            }
            
            // 2. æ›´æ–°ä»»åŠ¡æ€»æ•°
            exportTaskService.updateTaskTotal(taskId, totalCount);
            
            // 3. åˆ›å»ºExcelå·¥ä½œç°¿ï¼ˆä½¿ç”¨æµå¼å†™å…¥ï¼Œå†…å­˜ä¸­åªä¿ç•™100è¡Œï¼‰
            workbook = new SXSSFWorkbook(100);
            workbook.setCompressTempFiles(true); // å¯ç”¨ä¸´æ—¶æ–‡ä»¶å‹ç¼©
            Sheet sheet = workbook.createSheet("æ•°æ®");
            
            // 4. åˆ›å»ºæ ·å¼
            CellStyle headerStyle = createHeaderStyle(workbook);
            CellStyle dataStyle = createDataStyle(workbook);
            
            // 5. åˆ›å»ºè¡¨å¤´
            createHeaderRow(sheet, rowConverter.getHeaders(), headerStyle);
            
            // 6. è®¾ç½®åˆ—å®½
            setColumnWidths(sheet, rowConverter.getColumnWidths());
            
            // 7. åˆ†æ‰¹å¤„ç†æ•°æ®
            int batchSize = 100; // æ¯æ‰¹å¤„ç†100æ¡
            int processedCount = 0;
            int offset = 0;
            
            while (processedCount < totalCount) {
                // åˆ†é¡µæŸ¥è¯¢æ•°æ®
                List<T> dataList = dataProvider.queryData(queryParams, offset, batchSize);
                
                if (dataList == null || dataList.isEmpty()) {
                    break;
                }
                
                // å†™å…¥Excel
                for (T data : dataList) {
                    int rowNum = processedCount + 1; // è·³è¿‡è¡¨å¤´
                    Row row = sheet.createRow(rowNum);
                    
                    // è½¬æ¢æ•°æ®åˆ°Excelè¡Œ
                    rowConverter.convertToRow(workbook, row, data, rowNum);
                    
                    processedCount++;
                }
                
                // æ›´æ–°è¿›åº¦
                int progress = (int) ((processedCount * 100.0) / totalCount);
                exportTaskService.updateTaskProgress(taskId, progress, processedCount);
                log.info("å¯¼å‡ºè¿›åº¦: {}/{} ({}%)", processedCount, totalCount, progress);
                
                offset += batchSize;
            }
            
            // 8. ä¿å­˜æ–‡ä»¶
            String fileName = generateFileName(taskType);
            File exportFile = saveWorkbook(workbook, fileName);
            
            log.info("å¯¼å‡ºå®Œæˆ: file={}, size={}", exportFile.getAbsolutePath(), exportFile.length());
            
            // 9. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºæˆåŠŸ
            exportTaskService.updateTaskSuccess(
                taskId, 
                exportFile.getAbsolutePath(), 
                fileName, 
                exportFile.length()
            );
            
        } catch (Exception e) {
            log.error("å¯¼å‡ºä»»åŠ¡æ‰§è¡Œå¤±è´¥: taskId={}", taskId, e);
            exportTaskService.updateTaskFailed(taskId, "å¯¼å‡ºå¤±è´¥: " + e.getMessage());
        } finally {
            // æ¸…ç†èµ„æº
            closeQuietly(fos);
            if (workbook != null) {
                try {
                    workbook.dispose(); // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    workbook.close();
                } catch (Exception e) {
                    log.error("å…³é—­å·¥ä½œç°¿å¤±è´¥", e);
                }
            }
        }
    }
    
    /**
     * åˆ›å»ºè¡¨å¤´æ ·å¼
     */
    private CellStyle createHeaderStyle(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        
        // èƒŒæ™¯è‰²
        style.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        
        // è¾¹æ¡†
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        
        // å¯¹é½æ–¹å¼
        style.setAlignment(HorizontalAlignment.CENTER);
        style.setVerticalAlignment(VerticalAlignment.CENTER);
        
        // å­—ä½“
        Font font = workbook.createFont();
        font.setBold(true);
        font.setFontHeightInPoints((short) 11);
        style.setFont(font);
        
        return style;
    }
    
    /**
     * åˆ›å»ºæ•°æ®æ ·å¼
     */
    private CellStyle createDataStyle(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        
        // è¾¹æ¡†
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        
        // å¯¹é½æ–¹å¼
        style.setAlignment(HorizontalAlignment.LEFT);
        style.setVerticalAlignment(VerticalAlignment.CENTER);
        style.setWrapText(true); // è‡ªåŠ¨æ¢è¡Œ
        
        return style;
    }
    
    /**
     * åˆ›å»ºè¡¨å¤´è¡Œ
     */
    private void createHeaderRow(Sheet sheet, String[] headers, CellStyle headerStyle) {
        Row headerRow = sheet.createRow(0);
        headerRow.setHeight((short) 500); // è®¾ç½®è¡Œé«˜
        
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }
    }
    
    /**
     * è®¾ç½®åˆ—å®½
     */
    private void setColumnWidths(Sheet sheet, int[] columnWidths) {
        if (columnWidths == null || columnWidths.length == 0) {
            return;
        }
        
        for (int i = 0; i < columnWidths.length; i++) {
            sheet.setColumnWidth(i, columnWidths[i]);
        }
    }
    
    /**
     * ç”Ÿæˆæ–‡ä»¶å
     */
    private String generateFileName(String taskType) {
        String timestamp = DateUtil.format(new Date(), "yyyyMMdd_HHmmss");
        return String.format("%s_%s.xlsx", taskType, timestamp);
    }
    
    /**
     * ä¿å­˜å·¥ä½œç°¿åˆ°æ–‡ä»¶
     */
    private File saveWorkbook(SXSSFWorkbook workbook, String fileName) throws Exception {
        // åˆ›å»ºæŒ‰æ—¥æœŸåˆ†ç»„çš„ç›®å½•
        String dateDir = DateUtil.format(new Date(), "yyyy/MM/dd");
        File exportDir = new File(exportFilePath, dateDir);
        
        if (!exportDir.exists()) {
            exportDir.mkdirs();
        }
        
        File exportFile = new File(exportDir, fileName);
        
        try (FileOutputStream fos = new FileOutputStream(exportFile)) {
            workbook.write(fos);
            fos.flush();
        }
        
        return exportFile;
    }
    
    /**
     * å®‰å…¨å…³é—­æµ
     */
    private void closeQuietly(AutoCloseable closeable) {
        if (closeable != null) {
            try {
                closeable.close();
            } catch (Exception e) {
                log.warn("å…³é—­èµ„æºå¤±è´¥", e);
            }
        }
    }
}
```

### 3.4 å¯¼å‡ºä»»åŠ¡å®ä½“

```java
package com.example.export.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * å¯¼å‡ºä»»åŠ¡å®ä½“
 */
@Data
@TableName("export_task")
public class ExportTask implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * ä»»åŠ¡ID
     */
    @TableId(type = IdType.ASSIGN_ID)
    private String id;
    
    /**
     * ä»»åŠ¡åç§°
     */
    private String taskName;
    
    /**
     * ä»»åŠ¡ç±»å‹
     */
    private String taskType;
    
    /**
     * çŠ¶æ€ï¼š0-å¾…å¤„ç†ï¼Œ1-å¤„ç†ä¸­ï¼Œ2-å·²å®Œæˆï¼Œ3-å¤±è´¥ï¼Œ4-å·²è¿‡æœŸ
     */
    private Integer status;
    
    /**
     * è¿›åº¦ç™¾åˆ†æ¯”ï¼š0-100
     */
    private Integer progress;
    
    /**
     * æŸ¥è¯¢å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰
     */
    private String queryParams;
    
    /**
     * æ€»è®°å½•æ•°
     */
    private Integer totalCount;
    
    /**
     * å·²å¤„ç†æ•°é‡
     */
    private Integer processedCount;
    
    /**
     * æ–‡ä»¶è·¯å¾„
     */
    private String filePath;
    
    /**
     * æ–‡ä»¶å
     */
    private String fileName;
    
    /**
     * æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
     */
    private Long fileSize;
    
    /**
     * é”™è¯¯ä¿¡æ¯
     */
    private String errorMsg;
    
    /**
     * åˆ›å»ºäºº
     */
    private String createUser;
    
    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;
    
    /**
     * å®Œæˆæ—¶é—´
     */
    private Date finishTime;
    
    // çŠ¶æ€å¸¸é‡
    public static final int STATUS_PENDING = 0;
    public static final int STATUS_PROCESSING = 1;
    public static final int STATUS_COMPLETED = 2;
    public static final int STATUS_FAILED = 3;
    public static final int STATUS_EXPIRED = 4;
}
```

### 3.5 å¯¼å‡ºä»»åŠ¡æœåŠ¡

```java
package com.example.export.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.example.export.entity.ExportTask;

/**
 * å¯¼å‡ºä»»åŠ¡æœåŠ¡æ¥å£
 */
public interface ExportTaskService extends IService<ExportTask> {
    
    /**
     * åˆ›å»ºå¯¼å‡ºä»»åŠ¡
     */
    String createExportTask(String taskName, String taskType, String queryParams, String createUser);
    
    /**
     * æ›´æ–°ä»»åŠ¡æ€»æ•°
     */
    void updateTaskTotal(String taskId, int totalCount);
    
    /**
     * æ›´æ–°ä»»åŠ¡è¿›åº¦
     */
    void updateTaskProgress(String taskId, int progress, int processedCount);
    
    /**
     * æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
     */
    void updateTaskSuccess(String taskId, String filePath, String fileName, long fileSize);
    
    /**
     * æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥
     */
    void updateTaskFailed(String taskId, String errorMsg);
    
    /**
     * æ£€æŸ¥ç”¨æˆ·å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶
     */
    boolean checkConcurrentLimit(String userId, int maxConcurrent);
}
```

```java
package com.example.export.service.impl;

import cn.hutool.core.util.IdUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.example.export.entity.ExportTask;
import com.example.export.mapper.ExportTaskMapper;
import com.example.export.service.ExportTaskService;
import org.springframework.stereotype.Service;

import java.util.Date;

/**
 * å¯¼å‡ºä»»åŠ¡æœåŠ¡å®ç°
 */
@Service
public class ExportTaskServiceImpl extends ServiceImpl<ExportTaskMapper, ExportTask> 
        implements ExportTaskService {
    
    @Override
    public String createExportTask(String taskName, String taskType, String queryParams, String createUser) {
        ExportTask task = new ExportTask();
        task.setId(IdUtil.fastSimpleUUID());
        task.setTaskName(taskName);
        task.setTaskType(taskType);
        task.setStatus(ExportTask.STATUS_PENDING);
        task.setProgress(0);
        task.setQueryParams(queryParams);
        task.setProcessedCount(0);
        task.setCreateUser(createUser);
        task.setCreateTime(new Date());
        
        this.save(task);
        return task.getId();
    }
    
    @Override
    public void updateTaskTotal(String taskId, int totalCount) {
        ExportTask task = new ExportTask();
        task.setId(taskId);
        task.setTotalCount(totalCount);
        task.setStatus(ExportTask.STATUS_PROCESSING);
        this.updateById(task);
    }
    
    @Override
    public void updateTaskProgress(String taskId, int progress, int processedCount) {
        ExportTask task = new ExportTask();
        task.setId(taskId);
        task.setStatus(ExportTask.STATUS_PROCESSING);
        task.setProgress(progress);
        task.setProcessedCount(processedCount);
        this.updateById(task);
    }
    
    @Override
    public void updateTaskSuccess(String taskId, String filePath, String fileName, long fileSize) {
        ExportTask task = new ExportTask();
        task.setId(taskId);
        task.setStatus(ExportTask.STATUS_COMPLETED);
        task.setProgress(100);
        task.setFilePath(filePath);
        task.setFileName(fileName);
        task.setFileSize(fileSize);
        task.setFinishTime(new Date());
        this.updateById(task);
    }
    
    @Override
    public void updateTaskFailed(String taskId, String errorMsg) {
        ExportTask task = new ExportTask();
        task.setId(taskId);
        task.setStatus(ExportTask.STATUS_FAILED);
        task.setErrorMsg(errorMsg);
        task.setFinishTime(new Date());
        this.updateById(task);
    }
    
    @Override
    public boolean checkConcurrentLimit(String userId, int maxConcurrent) {
        LambdaQueryWrapper<ExportTask> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(ExportTask::getCreateUser, userId)
               .in(ExportTask::getStatus, 
                   ExportTask.STATUS_PENDING, 
                   ExportTask.STATUS_PROCESSING);
        
        long count = this.count(wrapper);
        return count < maxConcurrent;
    }
}
```

### 3.6 Mapperæ¥å£

```java
package com.example.export.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.example.export.entity.ExportTask;
import org.apache.ibatis.annotations.Mapper;

/**
 * å¯¼å‡ºä»»åŠ¡Mapper
 */
@Mapper
public interface ExportTaskMapper extends BaseMapper<ExportTask> {
}
```

### 3.7 çº¿ç¨‹æ± é…ç½®

```java
package com.example.export.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

import java.util.concurrent.Executor;
import java.util.concurrent.ThreadPoolExecutor;

/**
 * å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± é…ç½®
 */
@Configuration
@EnableAsync
public class AsyncExportConfig {
    
    /**
     * å¯¼å‡ºä»»åŠ¡çº¿ç¨‹æ± 
     */
    @Bean("exportTaskExecutor")
    public Executor exportTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        
        // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setCorePoolSize(2);
        
        // æœ€å¤§çº¿ç¨‹æ•°
        executor.setMaxPoolSize(5);
        
        // é˜Ÿåˆ—å®¹é‡
        executor.setQueueCapacity(100);
        
        // çº¿ç¨‹ç©ºé—²æ—¶é—´(ç§’)
        executor.setKeepAliveSeconds(60);
        
        // çº¿ç¨‹åç§°å‰ç¼€
        executor.setThreadNamePrefix("export-task-");
        
        // æ‹’ç»ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ï¼ˆç¡®ä¿ä»»åŠ¡ä¸ä¸¢å¤±ï¼‰
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡ç»“æŸåå†å…³é—­çº¿ç¨‹æ± 
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.setAwaitTerminationSeconds(60);
        
        executor.initialize();
        return executor;
    }
}
```

### 3.8 æ§åˆ¶å™¨

```java
package com.example.export.controller;

import cn.hutool.json.JSONUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.example.export.entity.ExportTask;
import com.example.export.service.ExportTaskService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.File;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;

/**
 * å¯¼å‡ºä»»åŠ¡æ§åˆ¶å™¨
 */
@Slf4j
@RestController
@RequestMapping("/api/export")
public class ExportTaskController {
    
    @javax.annotation.Resource
    private ExportTaskService exportTaskService;
    
    @Value("${export.max-concurrent-per-user:3}")
    private int maxConcurrentPerUser;
    
    /**
     * æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
     */
    @GetMapping("/task/status/{taskId}")
    public ResponseEntity<Map<String, Object>> getTaskStatus(@PathVariable String taskId) {
        ExportTask task = exportTaskService.getById(taskId);
        
        if (task == null) {
            return ResponseEntity.ok(createErrorResponse("ä»»åŠ¡ä¸å­˜åœ¨"));
        }
        
        Map<String, Object> data = new HashMap<>();
        data.put("taskId", task.getId());
        data.put("taskName", task.getTaskName());
        data.put("status", task.getStatus());
        data.put("progress", task.getProgress());
        data.put("totalCount", task.getTotalCount());
        data.put("processedCount", task.getProcessedCount());
        data.put("fileName", task.getFileName());
        data.put("fileSize", task.getFileSize());
        data.put("errorMsg", task.getErrorMsg());
        data.put("createTime", task.getCreateTime());
        data.put("finishTime", task.getFinishTime());
        
        return ResponseEntity.ok(createSuccessResponse(data));
    }
    
    /**
     * æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
     */
    @GetMapping("/task/list")
    public ResponseEntity<Map<String, Object>> getTaskList(
            @RequestParam(defaultValue = "1") int current,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(required = false) String createUser) {
        
        Page<ExportTask> page = new Page<>(current, size);
        LambdaQueryWrapper<ExportTask> wrapper = new LambdaQueryWrapper<>();
        
        if (createUser != null) {
            wrapper.eq(ExportTask::getCreateUser, createUser);
        }
        
        wrapper.orderByDesc(ExportTask::getCreateTime);
        
        Page<ExportTask> result = exportTaskService.page(page, wrapper);
        
        Map<String, Object> data = new HashMap<>();
        data.put("records", result.getRecords());
        data.put("total", result.getTotal());
        data.put("current", result.getCurrent());
        data.put("size", result.getSize());
        
        return ResponseEntity.ok(createSuccessResponse(data));
    }
    
    /**
     * ä¸‹è½½å¯¼å‡ºæ–‡ä»¶
     */
    @GetMapping("/task/download/{taskId}")
    public ResponseEntity<Resource> downloadFile(@PathVariable String taskId) {
        ExportTask task = exportTaskService.getById(taskId);
        
        if (task == null || task.getStatus() != ExportTask.STATUS_COMPLETED) {
            return ResponseEntity.badRequest().build();
        }
        
        File file = new File(task.getFilePath());
        
        if (!file.exists()) {
            log.error("æ–‡ä»¶ä¸å­˜åœ¨: {}", task.getFilePath());
            return ResponseEntity.notFound().build();
        }
        
        try {
            // æ–‡ä»¶åç¼–ç 
            String encodedFileName = URLEncoder.encode(task.getFileName(), StandardCharsets.UTF_8.toString())
                    .replaceAll("\\+", "%20");
            
            Resource resource = new FileSystemResource(file);
            
            return ResponseEntity.ok()
                    .contentType(MediaType.APPLICATION_OCTET_STREAM)
                    .header(HttpHeaders.CONTENT_DISPOSITION, 
                            "attachment; filename*=UTF-8''" + encodedFileName)
                    .body(resource);
                    
        } catch (UnsupportedEncodingException e) {
            log.error("æ–‡ä»¶åç¼–ç å¤±è´¥", e);
            return ResponseEntity.internalServerError().build();
        }
    }
    
    /**
     * åˆ é™¤ä»»åŠ¡
     */
    @DeleteMapping("/task/{taskId}")
    public ResponseEntity<Map<String, Object>> deleteTask(@PathVariable String taskId) {
        ExportTask task = exportTaskService.getById(taskId);
        
        if (task == null) {
            return ResponseEntity.ok(createErrorResponse("ä»»åŠ¡ä¸å­˜åœ¨"));
        }
        
        // åˆ é™¤æ–‡ä»¶
        if (task.getFilePath() != null) {
            File file = new File(task.getFilePath());
            if (file.exists()) {
                file.delete();
            }
        }
        
        // åˆ é™¤è®°å½•
        exportTaskService.removeById(taskId);
        
        return ResponseEntity.ok(createSuccessResponse("åˆ é™¤æˆåŠŸ"));
    }
    
    /**
     * åˆ›å»ºæˆåŠŸå“åº”
     */
    private Map<String, Object> createSuccessResponse(Object data) {
        Map<String, Object> response = new HashMap<>();
        response.put("code", 200);
        response.put("msg", "success");
        response.put("data", data);
        return response;
    }
    
    /**
     * åˆ›å»ºé”™è¯¯å“åº”
     */
    private Map<String, Object> createErrorResponse(String message) {
        Map<String, Object> response = new HashMap<>();
        response.put("code", 500);
        response.put("msg", message);
        response.put("data", null);
        return response;
    }
}
```

---

## å››ã€ä½¿ç”¨ç¤ºä¾‹

### 4.1 ç¤ºä¾‹1ï¼šå¯¼å‡ºç”¨æˆ·æ•°æ®

```java
package com.example.demo.user;

import com.example.export.core.ExportDataProvider;
import com.example.export.core.ExcelRowConverter;
import com.example.export.core.GenericAsyncExportHandler;
import com.example.export.service.ExportTaskService;
import cn.hutool.core.date.DateUtil;
import cn.hutool.json.JSONUtil;
import lombok.Data;
import org.apache.poi.ss.usermodel.*;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.*;

/**
 * ç”¨æˆ·æ•°æ®å¯¼å‡ºç¤ºä¾‹
 */
@RestController
@RequestMapping("/api/user")
public class UserExportController {
    
    @Resource
    private UserExportService userExportService;
    
    @Resource
    private ExportTaskService exportTaskService;
    
    @Resource
    private GenericAsyncExportHandler exportHandler;
    
    /**
     * åˆ›å»ºå¯¼å‡ºä»»åŠ¡
     */
    @PostMapping("/export")
    public Map<String, Object> exportUsers(@RequestBody UserQueryParams params) {
        // æ£€æŸ¥å¹¶å‘é™åˆ¶
        if (!exportTaskService.checkConcurrentLimit(params.getUserId(), 3)) {
            return createErrorResponse("å¯¼å‡ºä»»åŠ¡è¿‡å¤šï¼Œè¯·ç¨åå†è¯•");
        }
        
        // åˆ›å»ºä»»åŠ¡
        String taskName = "ç”¨æˆ·æ•°æ®å¯¼å‡º_" + DateUtil.now();
        String queryParams = JSONUtil.toJsonStr(params);
        String taskId = exportTaskService.createExportTask(
            taskName, 
            "user_data", 
            queryParams, 
            params.getUserId()
        );
        
        // å¼‚æ­¥æ‰§è¡Œ
        exportHandler.executeExport(
            taskId,
            "user_data",
            userExportService.getDataProvider(),
            userExportService.getRowConverter(),
            queryParams
        );
        
        return createSuccessResponse(taskId);
    }
    
    private Map<String, Object> createSuccessResponse(Object data) {
        Map<String, Object> response = new HashMap<>();
        response.put("code", 200);
        response.put("msg", "success");
        response.put("data", data);
        return response;
    }
    
    private Map<String, Object> createErrorResponse(String message) {
        Map<String, Object> response = new HashMap<>();
        response.put("code", 500);
        response.put("msg", message);
        return response;
    }
}

/**
 * ç”¨æˆ·å¯¼å‡ºæœåŠ¡
 */
@Service
class UserExportService {
    
    @Resource
    private UserMapper userMapper;
    
    /**
     * è·å–æ•°æ®æä¾›è€…
     */
    public ExportDataProvider<User> getDataProvider() {
        return new ExportDataProvider<User>() {
            @Override
            public int queryTotalCount(String params) {
                UserQueryParams queryParams = JSONUtil.toBean(params, UserQueryParams.class);
                return userMapper.countByParams(queryParams);
            }
            
            @Override
            public List<User> queryData(String params, int offset, int limit) {
                UserQueryParams queryParams = JSONUtil.toBean(params, UserQueryParams.class);
                queryParams.setOffset(offset);
                queryParams.setLimit(limit);
                return userMapper.selectByParams(queryParams);
            }
        };
    }
    
    /**
     * è·å–è¡Œè½¬æ¢å™¨
     */
    public ExcelRowConverter<User> getRowConverter() {
        return new ExcelRowConverter<User>() {
            @Override
            public String[] getHeaders() {
                return new String[]{"ç”¨æˆ·ID", "ç”¨æˆ·å", "å§“å", "é‚®ç®±", "æ‰‹æœºå·", "çŠ¶æ€", "åˆ›å»ºæ—¶é—´"};
            }
            
            @Override
            public int[] getColumnWidths() {
                return new int[]{3000, 4000, 3000, 5000, 4000, 2500, 5000};
            }
            
            @Override
            public void convertToRow(Workbook workbook, Row row, User user, int rowIndex) {
                CellStyle dataStyle = createDataStyle(workbook);
                
                createCell(row, 0, user.getId(), dataStyle);
                createCell(row, 1, user.getUsername(), dataStyle);
                createCell(row, 2, user.getRealName(), dataStyle);
                createCell(row, 3, user.getEmail(), dataStyle);
                createCell(row, 4, user.getPhone(), dataStyle);
                createCell(row, 5, user.getStatus() == 1 ? "æ­£å¸¸" : "ç¦ç”¨", dataStyle);
                createCell(row, 6, DateUtil.formatDateTime(user.getCreateTime()), dataStyle);
            }
            
            private void createCell(Row row, int column, String value, CellStyle style) {
                Cell cell = row.createCell(column);
                cell.setCellValue(value != null ? value : "");
                cell.setCellStyle(style);
            }
            
            private CellStyle createDataStyle(Workbook workbook) {
                CellStyle style = workbook.createCellStyle();
                style.setBorderBottom(BorderStyle.THIN);
                style.setBorderTop(BorderStyle.THIN);
                style.setBorderLeft(BorderStyle.THIN);
                style.setBorderRight(BorderStyle.THIN);
                style.setAlignment(HorizontalAlignment.LEFT);
                style.setVerticalAlignment(VerticalAlignment.CENTER);
                return style;
            }
        };
    }
}

/**
 * ç”¨æˆ·å®ä½“
 */
@Data
class User {
    private String id;
    private String username;
    private String realName;
    private String email;
    private String phone;
    private Integer status;
    private Date createTime;
}

/**
 * æŸ¥è¯¢å‚æ•°
 */
@Data
class UserQueryParams {
    private String userId;      // å½“å‰ç”¨æˆ·ID
    private String username;
    private String realName;
    private Integer status;
    private Date startTime;
    private Date endTime;
    private Integer offset;
    private Integer limit;
}
```

### 4.2 ç¤ºä¾‹2ï¼šå¯¼å‡ºå¸¦å›¾ç‰‡çš„å•†å“æ•°æ®

```java
package com.example.demo.product;

import com.example.export.core.ExportDataProvider;
import com.example.export.core.ExcelRowConverter;
import com.example.export.core.GenericAsyncExportHandler;
import com.example.export.service.ExportTaskService;
import cn.hutool.http.HttpUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.ss.util.CellRangeAddress;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.net.URL;
import java.util.concurrent.*;

/**
 * å•†å“å¯¼å‡ºæœåŠ¡ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
 */
@Slf4j
@Service
class ProductExportService {
    
    @Resource
    private ProductMapper productMapper;
    
    // å›¾ç‰‡ä¸‹è½½çº¿ç¨‹æ± 
    private final ExecutorService imageExecutor = new ThreadPoolExecutor(
        10, 20, 60L, TimeUnit.SECONDS,
        new LinkedBlockingQueue<>(1000),
        new ThreadPoolExecutor.CallerRunsPolicy()
    );
    
    /**
     * è·å–æ•°æ®æä¾›è€…
     */
    public ExportDataProvider<Product> getDataProvider() {
        return new ExportDataProvider<Product>() {
            @Override
            public int queryTotalCount(String params) {
                return productMapper.countAll();
            }
            
            @Override
            public List<Product> queryData(String params, int offset, int limit) {
                return productMapper.selectPage(offset, limit);
            }
        };
    }
    
    /**
     * è·å–è¡Œè½¬æ¢å™¨ï¼ˆå¸¦å›¾ç‰‡ï¼‰
     */
    public ExcelRowConverter<Product> getRowConverter() {
        return new ExcelRowConverter<Product>() {
            @Override
            public String[] getHeaders() {
                return new String[]{"å•†å“ID", "å•†å“åç§°", "ä»·æ ¼", "åº“å­˜", "åˆ†ç±»", "å•†å“å›¾ç‰‡"};
            }
            
            @Override
            public int[] getColumnWidths() {
                return new int[]{3000, 6000, 3000, 3000, 4000, 5000};
            }
            
            @Override
            public void convertToRow(Workbook workbook, Row row, Product product, int rowIndex) {
                // è®¾ç½®è¡Œé«˜ï¼ˆå›¾ç‰‡éœ€è¦æ›´é«˜çš„è¡Œï¼‰
                row.setHeight((short) 1200);
                
                CellStyle dataStyle = createDataStyle(workbook);
                
                createCell(row, 0, product.getId(), dataStyle);
                createCell(row, 1, product.getName(), dataStyle);
                createCell(row, 2, String.valueOf(product.getPrice()), dataStyle);
                createCell(row, 3, String.valueOf(product.getStock()), dataStyle);
                createCell(row, 4, product.getCategory(), dataStyle);
                createCell(row, 5, "", dataStyle);
                
                // å¼‚æ­¥ä¸‹è½½å¹¶æ’å…¥å›¾ç‰‡
                if (product.getImageUrl() != null) {
                    insertImageAsync(workbook, row.getSheet(), product.getImageUrl(), rowIndex);
                }
            }
            
            /**
             * å¼‚æ­¥æ’å…¥å›¾ç‰‡
             */
            private void insertImageAsync(Workbook workbook, Sheet sheet, String imageUrl, int rowIndex) {
                Future<byte[]> future = imageExecutor.submit(() -> downloadImage(imageUrl));
                
                try {
                    // 5ç§’è¶…æ—¶
                    byte[] imageBytes = future.get(5, TimeUnit.SECONDS);
                    
                    if (imageBytes != null && imageBytes.length > 0) {
                        // æ·»åŠ å›¾ç‰‡åˆ°å·¥ä½œç°¿
                        int pictureIdx = workbook.addPicture(imageBytes, Workbook.PICTURE_TYPE_JPEG);
                        
                        // åˆ›å»ºç»˜å›¾å¯¹è±¡
                        Drawing<?> drawing = sheet.createDrawingPatriarch();
                        
                        // è®¾ç½®å›¾ç‰‡ä½ç½®ï¼ˆç¬¬6åˆ—ï¼Œä»å½“å‰è¡Œåˆ°ä¸‹ä¸€è¡Œï¼‰
                        ClientAnchor anchor = drawing.createAnchor(
                            0, 0, 0, 0,     // dx1, dy1, dx2, dy2
                            5, rowIndex + 1, 6, rowIndex + 2  // col1, row1, col2, row2
                        );
                        
                        anchor.setAnchorType(ClientAnchor.AnchorType.MOVE_AND_RESIZE);
                        
                        // åˆ›å»ºå›¾ç‰‡
                        Picture picture = drawing.createPicture(anchor, pictureIdx);
                        picture.resize(1.0);  // è°ƒæ•´å¤§å°
                    }
                } catch (TimeoutException e) {
                    log.warn("å›¾ç‰‡ä¸‹è½½è¶…æ—¶: {}", imageUrl);
                    future.cancel(true);
                } catch (Exception e) {
                    log.warn("æ’å…¥å›¾ç‰‡å¤±è´¥: {}", imageUrl, e);
                }
            }
            
            /**
             * ä¸‹è½½å›¾ç‰‡
             */
            private byte[] downloadImage(String imageUrl) {
                try {
                    URL url = new URL(imageUrl);
                    try (InputStream in = url.openStream();
                         ByteArrayOutputStream out = new ByteArrayOutputStream()) {
                        
                        byte[] buffer = new byte[8192];
                        int bytesRead;
                        while ((bytesRead = in.read(buffer)) != -1) {
                            out.write(buffer, 0, bytesRead);
                        }
                        return out.toByteArray();
                    }
                } catch (Exception e) {
                    log.warn("ä¸‹è½½å›¾ç‰‡å¤±è´¥: {}", imageUrl, e);
                    return null;
                }
            }
            
            private void createCell(Row row, int column, String value, CellStyle style) {
                Cell cell = row.createCell(column);
                cell.setCellValue(value != null ? value : "");
                cell.setCellStyle(style);
            }
            
            private CellStyle createDataStyle(Workbook workbook) {
                CellStyle style = workbook.createCellStyle();
                style.setBorderBottom(BorderStyle.THIN);
                style.setBorderTop(BorderStyle.THIN);
                style.setBorderLeft(BorderStyle.THIN);
                style.setBorderRight(BorderStyle.THIN);
                style.setAlignment(HorizontalAlignment.CENTER);
                style.setVerticalAlignment(VerticalAlignment.CENTER);
                return style;
            }
        };
    }
}

/**
 * å•†å“å®ä½“
 */
@Data
class Product {
    private String id;
    private String name;
    private Double price;
    private Integer stock;
    private String category;
    private String imageUrl;
}
```

### 4.3 å‰ç«¯ä»£ç ï¼ˆVue3 + Element Plusï¼‰

```vue
<template>
  <div class="export-container">
    <!-- å¯¼å‡ºæŒ‰é’® -->
    <el-button type="primary" @click="handleExport">
      <el-icon><Download /></el-icon>
      å¯¼å‡ºæ•°æ®
    </el-button>
    
    <!-- å¯¼å‡ºå†å²æŒ‰é’® -->
    <el-button @click="showExportHistory">
      <el-icon><Document /></el-icon>
      å¯¼å‡ºè®°å½•
    </el-button>
    
    <!-- è¿›åº¦å¯¹è¯æ¡† -->
    <el-dialog
      v-model="progressVisible"
      title="å¯¼å‡ºè¿›åº¦"
      width="500px"
      :close-on-click-modal="false"
      :close-on-press-escape="false"
    >
      <div class="progress-content">
        <el-progress
          :percentage="taskInfo.progress"
          :status="getProgressStatus()"
        />
        
        <div class="progress-info">
          <p v-if="taskInfo.status === 0">ç­‰å¾…å¤„ç†...</p>
          <p v-else-if="taskInfo.status === 1">
            æ­£åœ¨å¤„ç†: {{ taskInfo.processedCount }} / {{ taskInfo.totalCount }}
          </p>
          <p v-else-if="taskInfo.status === 2" class="success">
            å¯¼å‡ºå®Œæˆï¼æ–‡ä»¶å¤§å°: {{ formatFileSize(taskInfo.fileSize) }}
          </p>
          <p v-else-if="taskInfo.status === 3" class="error">
            å¯¼å‡ºå¤±è´¥: {{ taskInfo.errorMsg }}
          </p>
        </div>
      </div>
      
      <template #footer>
        <el-button
          v-if="taskInfo.status === 2"
          type="primary"
          @click="downloadFile"
        >
          ä¸‹è½½æ–‡ä»¶
        </el-button>
        <el-button @click="progressVisible = false">å…³é—­</el-button>
      </template>
    </el-dialog>
    
    <!-- å¯¼å‡ºå†å²å¯¹è¯æ¡† -->
    <el-dialog
      v-model="historyVisible"
      title="å¯¼å‡ºè®°å½•"
      width="800px"
    >
      <el-table
        :data="historyList"
        v-loading="historyLoading"
        style="width: 100%"
      >
        <el-table-column prop="taskName" label="ä»»åŠ¡åç§°" width="200" />
        <el-table-column label="çŠ¶æ€" width="100">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.status)">
              {{ getStatusText(row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="progress" label="è¿›åº¦" width="100">
          <template #default="{ row }">
            {{ row.progress }}%
          </template>
        </el-table-column>
        <el-table-column prop="totalCount" label="è®°å½•æ•°" width="100" />
        <el-table-column label="æ–‡ä»¶å¤§å°" width="100">
          <template #default="{ row }">
            {{ formatFileSize(row.fileSize) }}
          </template>
        </el-table-column>
        <el-table-column prop="createTime" label="åˆ›å»ºæ—¶é—´" width="180" />
        <el-table-column label="æ“ä½œ" fixed="right">
          <template #default="{ row }">
            <el-button
              v-if="row.status === 2"
              link
              type="primary"
              @click="downloadHistoryFile(row.id)"
            >
              ä¸‹è½½
            </el-button>
            <el-button
              v-if="row.status === 1"
              link
              type="primary"
              @click="viewProgress(row.id)"
            >
              æŸ¥çœ‹è¿›åº¦
            </el-button>
            <el-button
              link
              type="danger"
              @click="deleteTask(row.id)"
            >
              åˆ é™¤
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <el-pagination
        v-model:current-page="pagination.current"
        v-model:page-size="pagination.size"
        :total="pagination.total"
        layout="total, prev, pager, next"
        @current-change="loadHistoryList"
      />
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive } from 'vue'
import { ElMessage } from 'element-plus'
import { Download, Document } from '@element-plus/icons-vue'
import axios from 'axios'

// è¿›åº¦å¯¹è¯æ¡†
const progressVisible = ref(false)
const taskInfo = reactive({
  taskId: '',
  status: 0,
  progress: 0,
  totalCount: 0,
  processedCount: 0,
  fileName: '',
  fileSize: 0,
  errorMsg: ''
})

// å†å²è®°å½•å¯¹è¯æ¡†
const historyVisible = ref(false)
const historyLoading = ref(false)
const historyList = ref([])
const pagination = reactive({
  current: 1,
  size: 10,
  total: 0
})

// è½®è¯¢å®šæ—¶å™¨
let pollingTimer = null

/**
 * åˆ›å»ºå¯¼å‡ºä»»åŠ¡
 */
const handleExport = async () => {
  try {
    const params = {
      userId: 'current-user-id', // ä»ç™»å½•ä¿¡æ¯è·å–
      // å…¶ä»–æŸ¥è¯¢å‚æ•°...
    }
    
    const response = await axios.post('/api/user/export', params)
    
    if (response.data.code === 200) {
      taskInfo.taskId = response.data.data
      taskInfo.status = 0
      taskInfo.progress = 0
      
      progressVisible.value = true
      startPolling()
      
      ElMessage.success('å¯¼å‡ºä»»åŠ¡å·²åˆ›å»º')
    } else {
      ElMessage.error(response.data.msg || 'åˆ›å»ºä»»åŠ¡å¤±è´¥')
    }
  } catch (error) {
    console.error('åˆ›å»ºå¯¼å‡ºä»»åŠ¡å¤±è´¥:', error)
    ElMessage.error('åˆ›å»ºå¯¼å‡ºä»»åŠ¡å¤±è´¥')
  }
}

/**
 * å¼€å§‹è½®è¯¢
 */
const startPolling = () => {
  stopPolling()
  queryTaskStatus()
  pollingTimer = setInterval(queryTaskStatus, 2000)
}

/**
 * åœæ­¢è½®è¯¢
 */
const stopPolling = () => {
  if (pollingTimer) {
    clearInterval(pollingTimer)
    pollingTimer = null
  }
}

/**
 * æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
 */
const queryTaskStatus = async () => {
  try {
    const response = await axios.get(`/api/export/task/status/${taskInfo.taskId}`)
    
    if (response.data.code === 200) {
      const data = response.data.data
      Object.assign(taskInfo, data)
      
      // ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
      if (data.status === 2 || data.status === 3) {
        stopPolling()
      }
    }
  } catch (error) {
    console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error)
  }
}

/**
 * ä¸‹è½½æ–‡ä»¶
 */
const downloadFile = async () => {
  try {
    ElMessage.info('å¼€å§‹ä¸‹è½½æ–‡ä»¶...')
    
    const response = await axios.get(
      `/api/export/task/download/${taskInfo.taskId}`,
      { responseType: 'blob' }
    )
    
    // åˆ›å»ºBlob
    const blob = new Blob([response.data], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    })
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = taskInfo.fileName
    link.click()
    
    // æ¸…ç†
    window.URL.revokeObjectURL(url)
    
    ElMessage.success('æ–‡ä»¶ä¸‹è½½æˆåŠŸ')
    progressVisible.value = false
  } catch (error) {
    console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error)
    ElMessage.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥')
  }
}

/**
 * æ˜¾ç¤ºå¯¼å‡ºå†å²
 */
const showExportHistory = () => {
  historyVisible.value = true
  pagination.current = 1
  loadHistoryList()
}

/**
 * åŠ è½½å†å²åˆ—è¡¨
 */
const loadHistoryList = async () => {
  try {
    historyLoading.value = true
    
    const response = await axios.get('/api/export/task/list', {
      params: {
        current: pagination.current,
        size: pagination.size,
        createUser: 'current-user-id' // ä»ç™»å½•ä¿¡æ¯è·å–
      }
    })
    
    if (response.data.code === 200) {
      historyList.value = response.data.data.records
      pagination.total = response.data.data.total
    }
  } catch (error) {
    console.error('åŠ è½½å¯¼å‡ºè®°å½•å¤±è´¥:', error)
    ElMessage.error('åŠ è½½å¯¼å‡ºè®°å½•å¤±è´¥')
  } finally {
    historyLoading.value = false
  }
}

/**
 * ä¸‹è½½å†å²æ–‡ä»¶
 */
const downloadHistoryFile = async (taskId) => {
  try {
    ElMessage.info('å¼€å§‹ä¸‹è½½æ–‡ä»¶...')
    
    const response = await axios.get(
      `/api/export/task/download/${taskId}`,
      { responseType: 'blob' }
    )
    
    // ä»å“åº”å¤´è·å–æ–‡ä»¶å
    const contentDisposition = response.headers['content-disposition']
    let fileName = 'å¯¼å‡ºæ–‡ä»¶.xlsx'
    if (contentDisposition) {
      const match = contentDisposition.match(/filename\*=UTF-8''(.+)/)
      if (match) {
        fileName = decodeURIComponent(match[1])
      }
    }
    
    // åˆ›å»ºä¸‹è½½
    const blob = new Blob([response.data])
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = fileName
    link.click()
    window.URL.revokeObjectURL(url)
    
    ElMessage.success('æ–‡ä»¶ä¸‹è½½æˆåŠŸ')
  } catch (error) {
    console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error)
    ElMessage.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥')
  }
}

/**
 * æŸ¥çœ‹è¿›åº¦
 */
const viewProgress = (taskId) => {
  taskInfo.taskId = taskId
  historyVisible.value = false
  progressVisible.value = true
  startPolling()
}

/**
 * åˆ é™¤ä»»åŠ¡
 */
const deleteTask = async (taskId) => {
  try {
    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ', 'æç¤º', {
      type: 'warning'
    })
    
    const response = await axios.delete(`/api/export/task/${taskId}`)
    
    if (response.data.code === 200) {
      ElMessage.success('åˆ é™¤æˆåŠŸ')
      loadHistoryList()
    } else {
      ElMessage.error(response.data.msg)
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error)
      ElMessage.error('åˆ é™¤ä»»åŠ¡å¤±è´¥')
    }
  }
}

/**
 * è·å–è¿›åº¦çŠ¶æ€
 */
const getProgressStatus = () => {
  if (taskInfo.status === 2) return 'success'
  if (taskInfo.status === 3) return 'exception'
  return null
}

/**
 * è·å–çŠ¶æ€æ–‡æœ¬
 */
const getStatusText = (status) => {
  const map = {
    0: 'ç­‰å¾…ä¸­',
    1: 'å¤„ç†ä¸­',
    2: 'å·²å®Œæˆ',
    3: 'å¤±è´¥',
    4: 'å·²è¿‡æœŸ'
  }
  return map[status] || 'æœªçŸ¥'
}

/**
 * è·å–çŠ¶æ€ç±»å‹
 */
const getStatusType = (status) => {
  const map = {
    0: 'info',
    1: 'warning',
    2: 'success',
    3: 'danger',
    4: 'info'
  }
  return map[status] || 'info'
}

/**
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
 */
const formatFileSize = (bytes) => {
  if (!bytes || bytes === 0) return '-'
  
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i]
}

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
onUnmounted(() => {
  stopPolling()
})
</script>

<style scoped>
.export-container {
  padding: 20px;
}

.progress-content {
  padding: 20px 0;
}

.progress-info {
  margin-top: 20px;
  text-align: center;
}

.progress-info p {
  margin: 10px 0;
  font-size: 14px;
}

.progress-info .success {
  color: #67c23a;
}

.progress-info .error {
  color: #f56c6c;
}
</style>
```

---

## äº”ã€é«˜çº§ç‰¹æ€§

### 5.1 å®šæ—¶æ¸…ç†è¿‡æœŸæ–‡ä»¶

```java
package com.example.export.task;

import cn.hutool.core.date.DateUtil;
import cn.hutool.core.io.FileUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.example.export.entity.ExportTask;
import com.example.export.service.ExportTaskService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.util.Date;
import java.util.List;

/**
 * å¯¼å‡ºæ–‡ä»¶æ¸…ç†ä»»åŠ¡
 */
@Slf4j
@Component
public class ExportFileCleanTask {
    
    @Resource
    private ExportTaskService exportTaskService;
    
    @Value("${export.keep-days:7}")
    private int keepDays;
    
    /**
     * æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void cleanExpiredFiles() {
        log.info("å¼€å§‹æ¸…ç†è¿‡æœŸå¯¼å‡ºæ–‡ä»¶ï¼Œä¿ç•™å¤©æ•°: {}", keepDays);
        
        try {
            // è®¡ç®—è¿‡æœŸæ—¶é—´
            Date expireDate = DateUtil.offsetDay(new Date(), -keepDays);
            
            // æŸ¥è¯¢è¿‡æœŸä¸”å·²å®Œæˆçš„ä»»åŠ¡
            LambdaQueryWrapper<ExportTask> wrapper = new LambdaQueryWrapper<>();
            wrapper.eq(ExportTask::getStatus, ExportTask.STATUS_COMPLETED)
                   .lt(ExportTask::getFinishTime, expireDate);
            
            List<ExportTask> expiredTasks = exportTaskService.list(wrapper);
            
            int successCount = 0;
            int failCount = 0;
            
            for (ExportTask task : expiredTasks) {
                try {
                    // åˆ é™¤æ–‡ä»¶
                    if (task.getFilePath() != null) {
                        FileUtil.del(task.getFilePath());
                    }
                    
                    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²è¿‡æœŸ
                    task.setStatus(ExportTask.STATUS_EXPIRED);
                    task.setFilePath(null);
                    exportTaskService.updateById(task);
                    
                    successCount++;
                } catch (Exception e) {
                    log.error("åˆ é™¤æ–‡ä»¶å¤±è´¥: {}", task.getFilePath(), e);
                    failCount++;
                }
            }
            
            log.info("æ¸…ç†å®Œæˆï¼ŒæˆåŠŸ: {}, å¤±è´¥: {}", successCount, failCount);
            
        } catch (Exception e) {
            log.error("æ¸…ç†è¿‡æœŸæ–‡ä»¶å¤±è´¥", e);
        }
    }
}
```

### 5.2 å…¨å±€å¼‚å¸¸å¤„ç†

```java
package com.example.export.exception;

import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.HashMap;
import java.util.Map;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(Exception.class)
    public Map<String, Object> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        
        Map<String, Object> response = new HashMap<>();
        response.put("code", 500);
        response.put("msg", "ç³»ç»Ÿå¼‚å¸¸: " + e.getMessage());
        response.put("data", null);
        
        return response;
    }
    
    @ExceptionHandler(IllegalArgumentException.class)
    public Map<String, Object> handleIllegalArgumentException(IllegalArgumentException e) {
        log.warn("å‚æ•°é”™è¯¯: {}", e.getMessage());
        
        Map<String, Object> response = new HashMap<>();
        response.put("code", 400);
        response.put("msg", e.getMessage());
        response.put("data", null);
        
        return response;
    }
}
```

### 5.3 å¹¶å‘æ§åˆ¶æ‹¦æˆªå™¨

```java
package com.example.export.interceptor;

import com.example.export.service.ExportTaskService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * å¯¼å‡ºå¹¶å‘æ§åˆ¶æ‹¦æˆªå™¨
 */
@Slf4j
@Component
public class ExportConcurrentInterceptor implements HandlerInterceptor {
    
    @Resource
    private ExportTaskService exportTaskService;
    
    @Value("${export.max-concurrent-per-user:3}")
    private int maxConcurrentPerUser;
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // è·å–å½“å‰ç”¨æˆ·IDï¼ˆä»Sessionæˆ–Tokenä¸­è·å–ï¼‰
        String userId = getCurrentUserId(request);
        
        if (userId == null) {
            return true;
        }
        
        // æ£€æŸ¥å¹¶å‘é™åˆ¶
        if (!exportTaskService.checkConcurrentLimit(userId, maxConcurrentPerUser)) {
            log.warn("ç”¨æˆ· {} å¯¼å‡ºä»»åŠ¡è¶…è¿‡é™åˆ¶", userId);
            response.setStatus(429); // Too Many Requests
            return false;
        }
        
        return true;
    }
    
    private String getCurrentUserId(HttpServletRequest request) {
        // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µä»Sessionæˆ–JWT Tokenä¸­è·å–ç”¨æˆ·ID
        return request.getHeader("User-Id");
    }
}
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```sql
-- ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_status_create_time ON export_task(status, create_time);

-- ç”¨æˆ·ä»»åŠ¡æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_user_status ON export_task(create_user, status);

-- è¿‡æœŸä»»åŠ¡æ¸…ç†ç´¢å¼•
CREATE INDEX idx_status_finish_time ON export_task(status, finish_time);
```

### 6.2 Excelå†™å…¥ä¼˜åŒ–

```java
// ä½¿ç”¨SXSSFWorkbookæµå¼å†™å…¥
SXSSFWorkbook workbook = new SXSSFWorkbook(100); // å†…å­˜ä¸­åªä¿ç•™100è¡Œ
workbook.setCompressTempFiles(true); // å‹ç¼©ä¸´æ—¶æ–‡ä»¶

// ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
sheet.setRandomAccessWindowSize(100);

// å®Œæˆåæ¸…ç†
workbook.dispose();
```

### 6.3 æŸ¥è¯¢ä¼˜åŒ–

```java
// ä½¿ç”¨æ¸¸æ ‡æ–¹å¼æŸ¥è¯¢å¤§æ•°æ®é‡
@Select("SELECT * FROM user WHERE status = #{status}")
@Options(resultSetType = ResultSetType.FORWARD_ONLY, fetchSize = 1000)
@ResultType(User.class)
void selectByStatus(@Param("status") Integer status, ResultHandler<User> handler);

// åœ¨å¯¼å‡ºæ—¶ä½¿ç”¨
userMapper.selectByStatus(1, context -> {
    User user = (User) context.getResultObject();
    writeToExcel(user);
});
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: å¯¼å‡ºä»»åŠ¡ä¸€ç›´å¤„äºå¾…å¤„ç†çŠ¶æ€ï¼Ÿ

**åŸå› **ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—å·²æ»¡æˆ–çº¿ç¨‹æ± æœªæ­£ç¡®é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥çº¿ç¨‹æ± é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
2. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸ä¿¡æ¯
3. ç¡®è®¤ `@EnableAsync` æ³¨è§£å·²æ·»åŠ 

### Q2: å†…å­˜æº¢å‡ºæ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ `SXSSFWorkbook` æ›¿ä»£ `XSSFWorkbook`
2. å‡å°æ‰¹æ¬¡å¤§å° `batchSize`
3. è°ƒæ•´ JVM å‚æ•° `-Xmx`

### Q3: å›¾ç‰‡ä¸‹è½½è¶…æ—¶å¯¼è‡´å¯¼å‡ºå˜æ…¢ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆ5-10ç§’ï¼‰
2. å¢åŠ å›¾ç‰‡ä¸‹è½½çº¿ç¨‹æ± å¤§å°
3. å›¾ç‰‡å¤±è´¥ä¸å½±å“æ•´ä½“å¯¼å‡º

### Q4: å¦‚ä½•å®ç°æ–­ç‚¹ç»­ä¼ ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// è®°å½•æœ€åå¤„ç†çš„offset
task.setLastOffset(offset);
exportTaskService.updateById(task);

// é‡è¯•æ—¶ä»lastOffsetå¼€å§‹
int startOffset = task.getLastOffset() != null ? task.getLastOffset() : 0;
```

### Q5: å¦‚ä½•æ”¯æŒæ›´å¤šæ–‡ä»¶æ ¼å¼ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- CSV: ä½¿ç”¨ `OpenCSV` åº“
- PDF: ä½¿ç”¨ `iText` æˆ– `Apache PDFBox`
- Word: ä½¿ç”¨ `Apache POI-OOXML`

---

## å…«ã€æ€»ç»“

æœ¬æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ª**å®Œæ•´ã€é€šç”¨ã€å¯æ‰©å±•**çš„Excelå¼‚æ­¥å¯¼å‡ºè§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **å¼€ç®±å³ç”¨**ï¼šåªéœ€å®ç°æ•°æ®æŸ¥è¯¢æ¥å£å³å¯å¿«é€Ÿé›†æˆ  
âœ… **é«˜æ€§èƒ½**ï¼šåˆ†æ‰¹å¤„ç†ã€æµå¼å†™å…¥ã€å¼‚æ­¥æ‰§è¡Œ  
âœ… **å¯æ‰©å±•**ï¼šæ³›å‹è®¾è®¡ï¼Œæ”¯æŒä»»æ„æ•°æ®ç±»å‹  
âœ… **ç”Ÿäº§å°±ç»ª**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†ã€æ—¥å¿—è®°å½•ã€ç›‘æ§

é€‚ç”¨äºå„ç±»éœ€è¦å¯¼å‡ºå¤§é‡æ•°æ®çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¦‚è®¢å•å¯¼å‡ºã€ç”¨æˆ·æ•°æ®å¯¼å‡ºã€è´¢åŠ¡æŠ¥è¡¨ç­‰ã€‚

---